# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.

# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Yul block contains `return` function call.](#h-1-yul-block-contains-return-function-call)
  - [H-2: Delegatecall made by the function without checks on any adress.](#h-2-delegatecall-made-by-the-function-without-checks-on-any-adress)
  - [H-3: Contract locks Ether without a withdraw function.](#h-3-contract-locks-ether-without-a-withdraw-function)
- [Low Issues](#low-issues)
  - [L-1: Unsafe ERC20 Operations should not be used](#l-1-unsafe-erc20-operations-should-not-be-used)
  - [L-2: Define and use `constant` variables instead of using literals](#l-2-define-and-use-constant-variables-instead-of-using-literals)
  - [L-3: Large literal values multiples of 10000 can be replaced with scientific notation](#l-3-large-literal-values-multiples-of-10000-can-be-replaced-with-scientific-notation)
  - [L-4: Loop contains `require`/`revert` statements](#l-4-loop-contains-requirerevert-statements)

# Summary

## Files Summary

| Key         | Value |
| ----------- | ----- |
| .sol Files  | 10    |
| Total nSLOC | 251   |

## Files Details

| Filepath                                        | nSLOC   |
| ----------------------------------------------- | ------- |
| contracts/CometCollateralSwap.sol               | 2       |
| contracts/CometMultiplierAdapter.sol            | 2       |
| contracts/plugins/flashloan/AAVEPlugin.sol      | 2       |
| contracts/plugins/flashloan/BalancerPlugin.sol  | 83      |
| contracts/plugins/flashloan/EulerV2Plugin.sol   | 2       |
| contracts/plugins/flashloan/MorphoPlugin.sol    | 32      |
| contracts/plugins/flashloan/UniswapV3Plugin.sol | 81      |
| contracts/plugins/swap/LiFiPlugin.sol           | 2       |
| contracts/plugins/swap/OneInchV6Plugin.sol      | 2       |
| contracts/plugins/swap/WstEthPlugin.sol         | 43      |
| **Total**                                       | **251** |

## Issue Summary

| Category | No. of Issues |
| -------- | ------------- |
| High     | 3             |
| Low      | 4             |

# High Issues

## H-1: Yul block contains `return` function call.

Remove this, as this causes execution to halt. Nothing after that call will execute, including code following the assembly block.

<details><summary>2 Found Instances</summary>

- Found in contracts/CometCollateralSwap.sol [Line: 182](contracts/CometCollateralSwap.sol#L182)

  ```solidity
              return(0x00, 0x20)
  ```

- Found in contracts/CometMultiplierAdapter.sol [Line: 99](contracts/CometMultiplierAdapter.sol#L99)

  ```solidity
              return(0x00, 0x20)
  ```

</details>

## H-2: Delegatecall made by the function without checks on any adress.

Introduce checks on the address

<details><summary>2 Found Instances</summary>

- Found in contracts/CometMultiplierAdapter.sol [Line: 151](contracts/CometMultiplierAdapter.sol#L151)

  ```solidity
      function withdrawMultiplier(
  ```

- Found in contracts/CometMultiplierAdapter.sol [Line: 164](contracts/CometMultiplierAdapter.sol#L164)

  ```solidity
      function withdrawMultiplierBySig(
  ```

</details>

## H-3: Contract locks Ether without a withdraw function.

It appears that the contract includes a payable function to accept Ether but lacks a corresponding function to withdraw it, which leads to the Ether being locked in the contract. To resolve this issue, please implement a public or external function that allows for the withdrawal of Ether from the contract.

<details><summary>6 Found Instances</summary>

- Found in contracts/CometMultiplierAdapter.sol [Line: 28](contracts/CometMultiplierAdapter.sol#L28)

  ```solidity
  contract CometMultiplierAdapter is ReentrancyGuard, ICometMultiplierAdapter, IAllowBySig {
  ```

- Found in contracts/plugins/flashloan/AAVEPlugin.sol [Line: 17](contracts/plugins/flashloan/AAVEPlugin.sol#L17)

  ```solidity
  contract AAVEPlugin is ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/BalancerPlugin.sol [Line: 17](contracts/plugins/flashloan/BalancerPlugin.sol#L17)

  ```solidity
  contract BalancerPlugin is IFlashLoanRecipient, ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/EulerV2Plugin.sol [Line: 16](contracts/plugins/flashloan/EulerV2Plugin.sol#L16)

  ```solidity
  contract EulerV2Plugin is ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/MorphoPlugin.sol [Line: 15](contracts/plugins/flashloan/MorphoPlugin.sol#L15)

  ```solidity
  contract MorphoPlugin is ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/UniswapV3Plugin.sol [Line: 16](contracts/plugins/flashloan/UniswapV3Plugin.sol#L16)

  ```solidity
  contract UniswapV3Plugin is ICometFlashLoanPlugin {
  ```

</details>

# Low Issues

## L-1: Unsafe ERC20 Operations should not be used

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>9 Found Instances</summary>

- Found in contracts/CometCollateralSwap.sol [Line: 151](contracts/CometCollateralSwap.sol#L151)

  ```solidity
          asset.approve(address(comet), debt);
  ```

- Found in contracts/CometCollateralSwap.sol [Line: 355](contracts/CometCollateralSwap.sol#L355)

  ```solidity
              asset.approve(address(comet), balance);
  ```

- Found in contracts/CometMultiplierAdapter.sol [Line: 287](contracts/CometMultiplierAdapter.sol#L287)

  ```solidity
          IERC20(collateral).approve(address(market), totalAmount);
  ```

- Found in contracts/CometMultiplierAdapter.sol [Line: 318](contracts/CometMultiplierAdapter.sol#L318)

  ```solidity
          IERC20(data.asset).approve(address(market), data.debt);
  ```

- Found in contracts/plugins/flashloan/AAVEPlugin.sol [Line: 71](contracts/plugins/flashloan/AAVEPlugin.sol#L71)

  ```solidity
          IERC20(asset).approve(flp, amount);
  ```

- Found in contracts/plugins/flashloan/MorphoPlugin.sol [Line: 39](contracts/plugins/flashloan/MorphoPlugin.sol#L39)

  ```solidity
          IERC20(baseAsset).approve(flp, amount);
  ```

- Found in contracts/plugins/swap/LiFiPlugin.sol [Line: 38](contracts/plugins/swap/LiFiPlugin.sol#L38)

  ```solidity
          IERC20(srcToken).approve(router, amountIn);
  ```

- Found in contracts/plugins/swap/OneInchV6Plugin.sol [Line: 37](contracts/plugins/swap/OneInchV6Plugin.sol#L37)

  ```solidity
          IERC20(srcToken).approve(router, amountIn);
  ```

- Found in contracts/plugins/swap/WstEthPlugin.sol [Line: 61](contracts/plugins/swap/WstEthPlugin.sol#L61)

  ```solidity
          IERC20(stEth).approve(wstEth, stAmount);
  ```

</details>

## L-2: Define and use `constant` variables instead of using literals

If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>2 Found Instances</summary>

- Found in contracts/CometMultiplierAdapter.sol [Line: 419](contracts/CometMultiplierAdapter.sol#L419)

  ```solidity
              Math.mulDiv(collateralAmount, price, 10 ** AggregatorV3Interface(info.priceFeed).decimals()),
  ```

- Found in contracts/CometMultiplierAdapter.sol [Line: 454](contracts/CometMultiplierAdapter.sol#L454)

  ```solidity
          return 10 ** AggregatorV3Interface(priceFeed).decimals() * scale;
  ```

</details>

## L-3: Large literal values multiples of 10000 can be replaced with scientific notation

Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>2 Found Instances</summary>

- Found in contracts/CometCollateralSwap.sol [Line: 66](contracts/CometCollateralSwap.sol#L66)

  ```solidity
      uint16 public constant BPS_DROP_DENOMINATOR = 10_000;
  ```

- Found in contracts/CometMultiplierAdapter.sol [Line: 32](contracts/CometMultiplierAdapter.sol#L32)

  ```solidity
  uint256 constant LEVERAGE_PRECISION = 10_000;
  ```

</details>

## L-4: Loop contains `require`/`revert` statements

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>1 Found Instances</summary>

- Found in contracts/CometMultiplierAdapter.sol [Line: 57](contracts/CometMultiplierAdapter.sol#L57)

  ```solidity
          for (uint256 i = 0; i < _plugins.length; i++) {
  ```

</details>
