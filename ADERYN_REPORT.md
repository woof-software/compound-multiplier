# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.

# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Yul block contains `return`](#h-1-yul-block-contains-return)
  - [H-2: Contract locks Ether without a withdraw function](#h-2-contract-locks-ether-without-a-withdraw-function)
  - [H-3: Reentrancy: State change after external call](#h-3-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Literal Instead of Constant](#l-1-literal-instead-of-constant)
  - [L-2: Unused State Variable](#l-2-unused-state-variable)
  - [L-3: Unused Import](#l-3-unused-import)
  - [L-4: State Change Without Event](#l-4-state-change-without-event)

# Summary

## Files Summary

| Key         | Value |
| ----------- | ----- |
| .sol Files  | 9     |
| Total nSLOC | 940   |

## Files Details

| Filepath                                        | nSLOC   |
| ----------------------------------------------- | ------- |
| contracts/CometFoundation.sol                   | 505     |
| contracts/plugins/flashloan/AAVEPlugin.sol      | 52      |
| contracts/plugins/flashloan/BalancerPlugin.sol  | 50      |
| contracts/plugins/flashloan/EulerV2Plugin.sol   | 41      |
| contracts/plugins/flashloan/MorphoPlugin.sol    | 39      |
| contracts/plugins/flashloan/UniswapV3Plugin.sol | 71      |
| contracts/plugins/swap/LiFiPlugin.sol           | 70      |
| contracts/plugins/swap/OneInchV6Plugin.sol      | 62      |
| contracts/plugins/swap/WstEthPlugin.sol         | 50      |
| **Total**                                       | **940** |

## Issue Summary

| Category | No. of Issues |
| -------- | ------------- |
| High     | 3             |
| Low      | 4             |

# High Issues

## H-1: Yul block contains `return`

This causes the transaction execution to halt, and nothing after that call will execute including code following the assembly block.

<details><summary>1 Found Instances</summary>

- Found in contracts/CometFoundation.sol [Line: 120](contracts/CometFoundation.sol#L120)

  ```solidity
              return(0x00, 0x20)
  ```

</details>

## H-2: Contract locks Ether without a withdraw function

It appears that the contract includes a payable function to accept Ether but lacks a corresponding function to withdraw it, which leads to the Ether being locked in the contract. To resolve this issue, please implement a public or external function that allows for the withdrawal of Ether from the contract.

<details><summary>6 Found Instances</summary>

- Found in contracts/CometFoundation.sol [Line: 36](contracts/CometFoundation.sol#L36)

  ```solidity
  contract CometFoundation is ICometFoundation, ICometExchange, ICometMultiplier, ICometCover, ReentrancyGuard {
  ```

- Found in contracts/plugins/flashloan/AAVEPlugin.sol [Line: 22](contracts/plugins/flashloan/AAVEPlugin.sol#L22)

  ```solidity
  contract AAVEPlugin is ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/BalancerPlugin.sol [Line: 21](contracts/plugins/flashloan/BalancerPlugin.sol#L21)

  ```solidity
  contract BalancerPlugin is IFlashLoanRecipient, ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/EulerV2Plugin.sol [Line: 21](contracts/plugins/flashloan/EulerV2Plugin.sol#L21)

  ```solidity
  contract EulerV2Plugin is ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/MorphoPlugin.sol [Line: 20](contracts/plugins/flashloan/MorphoPlugin.sol#L20)

  ```solidity
  contract MorphoPlugin is ICometFlashLoanPlugin {
  ```

- Found in contracts/plugins/flashloan/UniswapV3Plugin.sol [Line: 20](contracts/plugins/flashloan/UniswapV3Plugin.sol#L20)

  ```solidity
  contract UniswapV3Plugin is ICometFlashLoanPlugin {
  ```

</details>

## H-3: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>4 Found Instances</summary>

- Found in contracts/CometFoundation.sol [Line: 150](contracts/CometFoundation.sol#L150)

  State is changed at: `wEth = _wEth`, `plugins[key] = abi.encodePacked(PLUGIN_MAGIC, plugin.config)`

  ```solidity
              if (IERC165(plugin.endpoint).supportsInterface(type(ICometFlashLoanPlugin).interfaceId)) {
  ```

- Found in contracts/CometFoundation.sol [Line: 151](contracts/CometFoundation.sol#L151)

  State is changed at: `wEth = _wEth`, `plugins[key] = abi.encodePacked(PLUGIN_MAGIC, plugin.config)`

  ```solidity
                  pluginSelector = ICometFlashLoanPlugin(plugin.endpoint).CALLBACK_SELECTOR();
  ```

- Found in contracts/CometFoundation.sol [Line: 152](contracts/CometFoundation.sol#L152)

  State is changed at: `wEth = _wEth`, `plugins[key] = abi.encodePacked(PLUGIN_MAGIC, plugin.config)`

  ```solidity
              } else if (IERC165(plugin.endpoint).supportsInterface(type(ICometSwapPlugin).interfaceId)) {
  ```

- Found in contracts/CometFoundation.sol [Line: 153](contracts/CometFoundation.sol#L153)

  State is changed at: `wEth = _wEth`, `plugins[key] = abi.encodePacked(PLUGIN_MAGIC, plugin.config)`

  ```solidity
                  pluginSelector = ICometSwapPlugin(plugin.endpoint).SWAP_SELECTOR();
  ```

</details>

# Low Issues

## L-1: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>8 Found Instances</summary>

- Found in contracts/CometFoundation.sol [Line: 612](contracts/CometFoundation.sol#L612)

  ```solidity
                          10 ** AggregatorV3Interface(info.priceFeed).decimals()
  ```

- Found in contracts/CometFoundation.sol [Line: 636](contracts/CometFoundation.sol#L636)

  ```solidity
          uint256 den = (10 ** AggregatorV3Interface(priceFeed).decimals() * info.scale) * FACTOR_SCALE;
  ```

- Found in contracts/plugins/swap/LiFiPlugin.sol [Line: 75](contracts/plugins/swap/LiFiPlugin.sol#L75)

  ```solidity
          require(swapData.length > 4, ICA.InvalidSwapParameters());
  ```

- Found in contracts/plugins/swap/LiFiPlugin.sol [Line: 77](contracts/plugins/swap/LiFiPlugin.sol#L77)

  ```solidity
          require(bytes4(swapData[:4]) == SWAP_SELECTOR, ICA.InvalidSelector());
  ```

- Found in contracts/plugins/swap/LiFiPlugin.sol [Line: 89](contracts/plugins/swap/LiFiPlugin.sol#L89)

  ```solidity
          ) = abi.decode(swapData[4:], (bytes32, string, string, address, uint256, ILiFi.SwapData[]));
  ```

- Found in contracts/plugins/swap/OneInchV6Plugin.sol [Line: 70](contracts/plugins/swap/OneInchV6Plugin.sol#L70)

  ```solidity
          require(swapData.length > 4, ICA.InvalidSwapParameters());
  ```

- Found in contracts/plugins/swap/OneInchV6Plugin.sol [Line: 72](contracts/plugins/swap/OneInchV6Plugin.sol#L72)

  ```solidity
          require(bytes4(swapData[:4]) == SWAP_SELECTOR, ICA.InvalidSelector());
  ```

- Found in contracts/plugins/swap/OneInchV6Plugin.sol [Line: 80](contracts/plugins/swap/OneInchV6Plugin.sol#L80)

  ```solidity
              swapData[4:],
  ```

</details>

## L-2: Unused State Variable

State variable appears to be unused. No analysis has been performed to see if any inline assembly references it. Consider removing this unused variable.

<details><summary>7 Found Instances</summary>

- Found in contracts/CometFoundation.sol [Line: 46](contracts/CometFoundation.sol#L46)

  ```solidity
      uint8 internal constant SNAPSHOT_OFFSET = 0x20;
  ```

- Found in contracts/CometFoundation.sol [Line: 47](contracts/CometFoundation.sol#L47)

  ```solidity
      uint8 internal constant LOAN_PLUGIN_OFFSET = 0x40;
  ```

- Found in contracts/CometFoundation.sol [Line: 48](contracts/CometFoundation.sol#L48)

  ```solidity
      uint8 internal constant SWAP_PLUGIN_OFFSET = 0x60;
  ```

- Found in contracts/CometFoundation.sol [Line: 49](contracts/CometFoundation.sol#L49)

  ```solidity
      uint8 internal constant MARKET_OFFSET = 0x80;
  ```

- Found in contracts/CometFoundation.sol [Line: 50](contracts/CometFoundation.sol#L50)

  ```solidity
      uint8 internal constant ASSET_OFFSET = 0xA0;
  ```

- Found in contracts/CometFoundation.sol [Line: 51](contracts/CometFoundation.sol#L51)

  ```solidity
      uint8 internal constant AMOUNT_OFFSET = 0xC0;
  ```

- Found in contracts/CometFoundation.sol [Line: 52](contracts/CometFoundation.sol#L52)

  ```solidity
      uint8 internal constant USER_OFFSET = 0xE0;
  ```

</details>

## L-3: Unused Import

Redundant import statement. Consider removing it.

<details><summary>2 Found Instances</summary>

- Found in contracts/plugins/swap/LiFiPlugin.sol [Line: 10](contracts/plugins/swap/LiFiPlugin.sol#L10)

  ```solidity
  import { ICometStructs as ICS } from "../../interfaces/ICometStructs.sol";
  ```

- Found in contracts/plugins/swap/OneInchV6Plugin.sol [Line: 8](contracts/plugins/swap/OneInchV6Plugin.sol#L8)

  ```solidity
  import { ICometFoundation } from "../../interfaces/ICometFoundation.sol";
  ```

</details>

## L-4: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>6 Found Instances</summary>

- Found in contracts/CometFoundation.sol [Line: 176](contracts/CometFoundation.sol#L176)

  ```solidity
      function exchange(
  ```

- Found in contracts/CometFoundation.sol [Line: 191](contracts/CometFoundation.sol#L191)

  ```solidity
      function exchange(
  ```

- Found in contracts/CometFoundation.sol [Line: 207](contracts/CometFoundation.sol#L207)

  ```solidity
      function multiply(
  ```

- Found in contracts/CometFoundation.sol [Line: 220](contracts/CometFoundation.sol#L220)

  ```solidity
      function multiply(
  ```

- Found in contracts/CometFoundation.sol [Line: 234](contracts/CometFoundation.sol#L234)

  ```solidity
      function cover(
  ```

- Found in contracts/CometFoundation.sol [Line: 246](contracts/CometFoundation.sol#L246)

  ```solidity
      function cover(
  ```

</details>
